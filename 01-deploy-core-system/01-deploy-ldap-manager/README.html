<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>部署 LDAP 管理器</title>
<style>
@import url(https://fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>部署 LDAP 管理器</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_简介">简介</a></li>
<li><a href="#_创建_deployment">创建 Deployment</a>
<ul class="sectlevel2">
<li><a href="#_创建_service">创建 Service</a></li>
<li><a href="#_绑定_ingress">绑定 Ingress</a></li>
</ul>
</li>
<li><a href="#_验证">验证</a></li>
<li><a href="#_初始化配置">初始化配置</a>
<ul class="sectlevel2">
<li><a href="#_创建ou">创建OU</a></li>
<li><a href="#_创建默认角色">创建默认角色</a></li>
<li><a href="#_创建管理员用户">创建管理员用户</a></li>
<li><a href="#_创建管理员角色">创建管理员角色</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_简介">简介</h2>
<div class="sectionbody">
<div class="paragraph">
<p>此项目使用 <code>ldapaccountmanager</code> 作为 LDAP 管理器。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_创建_deployment">创建 Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>使用以下配置创建关联的 <code>Deployment</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">core-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ldap</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">ldap</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">ldapaccountmanager/lam:8.0.1</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LAM_SKIP_PRCONFIGURE</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LDAP_DOMAIN</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-global-conf</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">ldap_domain</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LDAP_SERVER</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-global-conf</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">ldap_url</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LDAP_BASE_DN</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-global-conf</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">ldap_base_dn</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LDAP_USERS_DN</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-global-conf</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">ldap_user_dn</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LDAP_GROUPS_DN</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-global-conf</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">ldap_group_dn</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LAM_LANG</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">zh_CN</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LAM_PASSWORD</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">secretKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-secret-admin</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>创建完成后使用 <code>kubectl get pods -n core-system</code> 查看创建结果。</p>
</div>
<div class="sect2">
<h3 id="_创建_service">创建 Service</h3>
<div class="paragraph">
<p>使用以下配置创建 Service ，关联之前创建的 Deployment。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">lam</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ldap</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">lam</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">core-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">ldap-account-manager</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>创建完成后使用 <code>kubectl get svc -n core-system</code> 查看创建结果。</p>
</div>
</div>
<div class="sect2">
<h3 id="_绑定_ingress">绑定 Ingress</h3>
<div class="paragraph">
<p>导入此配置，绑定 Ingress, 将 LAM 映射到外部地址。注意：里面标注的内容请按照实际情况修改。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ldap-ingress</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">core-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ldap</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="c1"># 重写路径</span>
    <span class="na">nginx.ingress.kubernetes.io/rewrite-target</span><span class="pi">:</span> <span class="s">/</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">tls</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">lam.d7z.net</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="na">secretName</span><span class="pi">:</span> <span class="s">d7z-net-tls</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">lam.d7z.net</span>  <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="na">http</span><span class="pi">:</span>
        <span class="na">paths</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
            <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
            <span class="na">backend</span><span class="pi">:</span>
              <span class="na">service</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">lam</span>  <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="na">port</span><span class="pi">:</span>
                  <span class="na">number</span><span class="pi">:</span> <span class="s">80</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>其中</p>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>指定 Ingress 暴露的 Host</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>指定 Ingress 使用的 TLS 证书 secret 名称</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>指定 Ingress 使用的 Host</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>指定 Ingress 绑定的 Service</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_验证">验证</h2>
<div class="sectionbody">
<div class="paragraph">
<p>访问地址 <code><a target="_blank" href="https://lam.d7z.net" class="bare">https://lam.d7z.net</a></code> , 使用 LDAP 配置的管理员密码登陆，如果登陆成功则表明安装正确。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
在测试时，你需要将 <code>lam.d7z.net</code> 改为实际的地址
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_初始化配置">初始化配置</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_创建ou">创建OU</h3>
<div class="paragraph">
<p>访问 <code><a target="_blank" href="https://lam.d7z.net" class="bare">https://lam.d7z.net</a></code> ，输入管理员密码登陆后可看到如下页面：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01-create-ou.png" alt="01 create ou">
</div>
</div>
<div class="paragraph">
<p>点击建立即可。</p>
</div>
</div>
<div class="sect2">
<h3 id="_创建默认角色">创建默认角色</h3>
<div class="paragraph">
<p>前往地址 <code><a target="_blank" href="https://lam.d7z.net/lam/templates/lists/list.php?type=group" class="bare">https://lam.d7z.net/lam/templates/lists/list.php?type=group</a></code>，点击创建新组，按如下所示输入保存即可。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/02-create-def-group.png" alt="02 create def group">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_创建管理员用户">创建管理员用户</h3>
<div class="paragraph">
<p>前往地址 <code><a target="_blank" href="https://lam.d7z.net/lam/templates/lists/list.php?type=user" class="bare">https://lam.d7z.net/lam/templates/lists/list.php?type=user</a></code> ，点击创建新用户，同时配置密码，按如下所示输入保存即可。注意 RDN 标志需配置为 <code>UID</code> 。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/03-create-adm.png" alt="03 create adm">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_创建管理员角色">创建管理员角色</h3>
<div class="paragraph">
<p>前往 <code><a target="_blank" href="https://lam.d7z.net/lam/templates/tools/treeView.php" class="bare">https://lam.d7z.net/lam/templates/tools/treeView.php</a></code> 页面，在 <code>ou=groups</code> 下方新建 <code>groupOfNames</code> 对象，按如下所示输入保存即可。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/04-create-adm-group.png" alt="04 create adm group">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
后续相关角色创建流程均参考此流程即可。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<div class="custom-content">
    <style>
        .custom-footer {
            margin: 0;
            padding: 20px;
            background: #555555;
            color: white;
        }

        .custom-footer a {
            color: white;
        }
    </style>
    <p class="custom-footer">
        最后编辑于 2022年07月19日 20时43分41秒 |
        <a target="_blank"
           href="https://github.com/d7z-project/all-in-kubernetes/tree/bf0421eac7c16eb1b8dd78be7e794cb724831993//01-deploy-core-system/01-deploy-ldap-manager/README.adoc">查看源码</a> |
        <a href="https://github.com/d7z-project/all-in-kubernetes/tree/bf0421eac7c16eb1b8dd78be7e794cb724831993/"
            target="_blank">#7720bf3</a>
</div>
</body>
</html>