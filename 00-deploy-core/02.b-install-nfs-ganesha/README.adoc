:experimental:
:icons: font

= 配置全局存储 (nfs-ganesha)

项目地址：link:https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner[nfs-ganesha-server-and-external-provisioner]

kubernetes 安装后可选择一个节点的某个目录作为集群数据存储目录。

== 导入 RBAC 规则和初始化

在开始前需要导入RBAC规则和初始化配置，此过程需要拉取镜像 `k8s.gcr.io/sig-storage/nfs-provisioner:v3.0.0`,同时需要集群上每个节点安装有 `nfs-common` 软件包。

.点击展开部署命令
[%collapsible]
====

[source,bash]
----
kubectl apply -f - << EOF
include::./conf/nfs-rbac.yaml[]
EOF
----

====

== 映射节点目录

具体步骤可参考 link:../02.a-install-rook-nfs/README.adoc[RookNFS] , 此处仅放置最终执行命令。

.点击展开部署命令
[%collapsible]
====

[source,bash]
----
kubectl apply -f - << EOF
include::./conf/local-storage.yaml[]
EOF
kubectl get pvc -n storage-nfs
kubectl get sc
----

====

== 安装 NFS Server

将上一操作创建的 PVC 绑定至 StatefulSet,然后通过 Service 暴露对应的端口，最后将目标绑定在 SC 即可 ,在此配置中，Provisioner 为 `nfs.3rd.storage.k8s.io/nfs-server-provisioner` 。

.点击展开部署命令
[%collapsible]
====

[source,bash]
----
kubectl apply -f - << EOF
include::./conf/nfs-server.yaml[]
EOF
kubectl get sc
----

====

== 验证部署情况

执行以下命令创建测试 pod

[source,bash]
----
kubectl apply -f - <<EOF
include::./conf/test.yaml[]
EOF

----

执行完成后使用 `kubectl get pods` 查看创建情况。创建完成后，执行以下命令，有数据返回则表示成功：

TIP: 如果返回403错误，可能是因为文件系统权限问题，可通过 `kubectl exec` 手动查看。

[source,bash]
----
echo; kubectl exec $(kubectl get pod -l app=nfs-demo,role=busybox -o jsonpath='{.items[0].metadata.name}') -- wget -qO- http://$(kubectl get services nfs-web -o jsonpath='{.spec.clusterIP}'); echo
----
