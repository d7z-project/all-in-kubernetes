:experimental:
:icons: font

= 初始化环境

安装 `kubernetes` 需要对系统进行某些必要的配置。

== 环境验证

=== 验证机器属性

安装 Kubernetes 需要保证机器硬件 UUID 和网卡 MAC 地址是独一无二的，如果这些值在每个节点上不唯一，可能会导致安装失败。可使用如下命令确认：

[source,bash]
----
include::./script/info-hardware-info-uuid.sh[lines=2..-1]
----

=== 验证网络联通性

各个节点之间需要能够相互通信,你可以 使用 `ping` 或者 `traceroute` 等工具进行测试。

== 配置系统

=== 启用内核模块

kubernetes 需要 `br_netfilter` 模块才能工作，debian 内核中已默认启用，可使用 `lsmod | grep br_netfilter` 验证，装入以下配置以显示加载模块。

[source,bash]
----
include::./script/conf-modprobe.sh[lines=2..-1]
----

=== 配置内核参数

为了让节点上的 `iptables` 能够正确地查看桥接流量，你需要确保 `sysctl` 配置中将 net.bridge.bridge-nf-call-iptables 设置为 1。

[source,bash]
----
include::./script/conf-sysctl.sh[lines=2..-1]
----

=== 安装容器运行时

Kubernetes 需要支撑 Pod 运行的实现。这里采用的是 link:https://containerd.io/[containerd]。

[source,bash]
----
include::./script/soft-install-containerd.sh[lines=2..-1]
----

=== 安装 kubeadm、kubelet 和 kubectl

你需要在每台机器上安装以下的软件包：

* `kubeadm` ：用来初始化集群的指令。
* `kubelet` ：在集群中的每个节点上用来启动 Pod 和容器等。
* `kubectl` ：用来与集群通信的命令行工具。

TIP: 如果是中国大陆用户，可能会出现某些网址无法访问的问题，请自备代理工具或者使用镜像地址。注意：对于 *导入证书等操作一定要再三确认*，谨防link:https://zh.m.wikipedia.org/zh/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB[中间人攻击]。

[source,bash]
----
include::./script/soft-install-kubeadm.sh[lines=2..-1]
----

== 参考

- [1] link:https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/[安装 kubeadm]
