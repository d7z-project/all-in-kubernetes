apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elastic-server
  namespace: core-middle
  labels:
    app: elastic-server
    type: elastic
spec:
  serviceName: elastic-server
  selector:
    matchLabels:
      app: elastic-server
  replicas: 1
  template:
    metadata:
      labels:
        app: elastic-server
        type: elastic
    spec:
      containers:
        - name: elastic-master
          image: docker.elastic.co/elasticsearch/elasticsearch:8.3.2
          volumeMounts:
            - name: elastic-data
              mountPath: /usr/share/elasticsearch/data
          ports:
            - containerPort: 9200
              name: api
            - containerPort: 9300
              name: cluster-port
          env:
            - name: discovery.type
              value: single-node
            - name: ES_JAVA_OPTS
              valueFrom:
                configMapKeyRef:
                  name: config-elastic-master
                  key: jvm.ops
            - name: ELASTICSEARCH_USERNAME
              valueFrom:
                secretKeyRef:
                  name: secret-elastic
                  key: username
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: secret-elastic
                  key: password
            - name: 'xpack.security.enabled'
              valueFrom:
                configMapKeyRef:
                  name: config-elastic-master
                  key: 'xpack.security.enabled'

      volumes:
        - name: elastic-data
          persistentVolumeClaim:
            claimName: pvc-elastic-data
