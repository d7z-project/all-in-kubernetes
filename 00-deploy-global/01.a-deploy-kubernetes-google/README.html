<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>部署 Kubernetes (Google)</title>
<style>
@import url(https://fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>部署 Kubernetes (Google)</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_部署软件包">部署软件包</a>
<ul class="sectlevel2">
<li><a href="#_部署容器运行时">部署容器运行时</a></li>
<li><a href="#_部署_kubeadmkubelet_和_kubectl">部署 kubeadm、kubelet 和 kubectl</a></li>
<li><a href="#_配置_containerd_网络代理_可选">配置 <code>containerd</code> 网络代理 (可选)</a></li>
<li><a href="#_预下载运行时镜像_可选">预下载运行时镜像 (可选)</a></li>
<li><a href="#_添加_tab_命令补全_可选">添加 TAB 命令补全 （可选）</a></li>
</ul>
</li>
<li><a href="#_部署_kubernetes">部署 kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_重置_kubernetes_可选">重置 kubernetes (可选)</a></li>
<li><a href="#_部署控制节点">部署控制节点</a></li>
<li><a href="#_部署_cni_插件">部署 CNI 插件</a></li>
<li><a href="#_部署工作节点">部署工作节点</a></li>
</ul>
</li>
<li><a href="#_参考">参考</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_部署软件包">部署软件包</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_部署容器运行时">部署容器运行时</h3>
<div class="paragraph">
<p>Kubernetes 需要支撑 Pod 运行的实现。这里采用的是 <a target="_blank" href="https://containerd.io/">containerd</a>。</p>
</div>
<details>
<summary class="title">点击展开部署命令</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="c"># 此脚本参考至 https://github.com/kubernetes/kubernetes/issues/106464#issuecomment-1142563656</span>
<span class="c"># 配置运行时版本</span>
<span class="c">## https://github.com/containerd/containerd</span>
<span class="nv">CONTAINERD_VERSION</span><span class="o">=</span>1.6.6
<span class="c">## https://github.com/opencontainers/runc</span>
<span class="nv">RUNC_VERSION</span><span class="o">=</span>1.1.3
<span class="c">## https://github.com/containernetworking/plugins</span>
<span class="nv">CNI_VERSION</span><span class="o">=</span>1.1.1
<span class="c"># 配置系统架构</span>
<span class="nv">ARCH</span><span class="o">=</span>amd64

apt-get autoremove <span class="nt">--purge</span> <span class="nt">-y</span> containerd containerd.io
<span class="c"># 部署 containerd</span>
wget https://github.com/containerd/containerd/releases/download/v<span class="nv">$CONTAINERD_VERSION</span>/containerd-<span class="nv">$CONTAINERD_VERSION</span><span class="nt">-linux-</span><span class="nv">$ARCH</span>.tar.gz <span class="nt">-c</span> <span class="nt">-O</span> /tmp/containerd.tgz
<span class="nb">tar </span>Cxzvf /usr/local /tmp/containerd.tgz
<span class="nb">mkdir</span> /etc/containerd/
containerd config default <span class="o">&gt;</span>/etc/containerd/config.toml
<span class="c"># 备注：在 Debian Bullseye 下已经默认启用 cgroup v2</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s|SystemdCgroup = false|SystemdCgroup = true|'</span> /etc/containerd/config.toml

<span class="c"># 部署 runc</span>
wget https://github.com/opencontainers/runc/releases/download/v<span class="nv">$RUNC_VERSION</span>/runc.<span class="nv">$ARCH</span> <span class="nt">-c</span> <span class="nt">-O</span> /tmp/runc
<span class="nb">install</span> <span class="nt">-m</span> 755 /tmp/runc /usr/local/sbin/runc

<span class="c"># 部署 CNI</span>
wget https://github.com/containernetworking/plugins/releases/download/v<span class="nv">$CNI_VERSION</span>/cni-plugins-linux-<span class="nv">$ARCH</span><span class="nt">-v</span><span class="nv">$CNI_VERSION</span>.tgz <span class="nt">-c</span> <span class="nt">-O</span> /tmp/cni-plugin.tgz
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/cni/bin
<span class="nb">tar </span>Cxzvf /opt/cni/bin /tmp/cni-plugin.tgz

<span class="c"># 配置 Systemd 服务</span>
wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service <span class="nt">--output-document</span><span class="o">=</span>/etc/systemd/system/containerd.service
systemctl daemon-reload
systemctl <span class="nb">enable</span> <span class="nt">--now</span> containerd
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_部署_kubeadmkubelet_和_kubectl">部署 kubeadm、kubelet 和 kubectl</h3>
<div class="paragraph">
<p>你需要在每台机器上部署以下的软件包：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubeadm</code> ：用来初始化集群的指令。</p>
</li>
<li>
<p><code>kubelet</code> ：在集群中的每个节点上用来启动 Pod 和容器等。</p>
</li>
<li>
<p><code>kubectl</code> ：用来与集群通信的命令行工具。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果是中国大陆用户，可能会出现某些网址无法访问的问题，请自备代理工具或者使用镜像地址。注意：对于 <strong>导入证书等操作一定要再三确认</strong>，谨防<a target="_blank" href="https://zh.m.wikipedia.org/zh/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB">中间人攻击</a>。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl
<span class="c"># 导入公钥对</span>
curl <span class="nt">-fsSLo</span> /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
<span class="c"># 配置 APT</span>
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://mirrors.ustc.edu.cn/kubernetes/apt/ kubernetes-xenial main"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/kubernetes.list
apt-get update
<span class="c"># 安装 kubeadm</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl cri-tools
<span class="c"># 锁定 kubernetes 版本</span>
apt-mark hold kubelet kubeadm kubectl cri-tools
<span class="c"># 配置 cri-tools</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | tee /etc/crictl.yaml
runtime-endpoint: unix:///var/run/containerd/containerd.sock
image-endpoint: unix:///var/run/containerd/containerd.sock
EOF</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置_containerd_网络代理_可选">配置 <code>containerd</code> 网络代理 (可选)</h3>
<div class="paragraph">
<p>在某些情况下，镜像可能因为网络原因无法拉取,此时可为 <code>containerd</code> 配置代理。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="nb">mkdir</span> /etc/systemd/system/containerd.service.d <span class="o">||</span>:
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">" &gt; /etc/systemd/system/containerd.service.d/http_proxy.conf
[Service]
# 此处配置为可用的 HTTP 代理地址
Environment="HTTP_PROXY=http://10.0.0.2:8080"
# 此处配置为可用的 HTTP 代理地址
Environment="HTTPS_PROXY=http://10.0.0.2:8080"
# 此处配置为跳过代理的地址
Environment="NO_PROXY=localhost,127.0.0.1,10.0.0.20"
</span><span class="no">EOF
</span>systemctl daemon-reload
systemctl restart containerd.service
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>取消代理可执行以下命令:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nb">rm</span> /etc/systemd/system/containerd.service.d/http_proxy.conf <span class="o">||</span>:
systemctl daemon-reload
systemctl restart containerd.service
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_预下载运行时镜像_可选">预下载运行时镜像 (可选)</h3>
<div class="paragraph">
<p>为防止因网络问题导致镜像下载失败致使 <code>kubernetes</code> 部署失败，可将所有 <code>kubernetes</code> 所用到的镜像预下载到本地。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="c"># 获取kubernetes需要的镜像列表</span>
<span class="nv">LIST</span><span class="o">=</span><span class="si">$(</span>kubeadm config images list<span class="si">)</span>
<span class="k">for </span>IMAGE <span class="k">in</span> <span class="nv">$LIST</span><span class="p">;</span> <span class="k">do</span>
    <span class="c"># 注意：环境变量 HTTP_PROXY 不会生效，详情可查看 https://github.com/kubernetes-sigs/cri-tools/issues/336</span>
    crictl pull <span class="s2">"</span><span class="nv">$IMAGE</span><span class="s2">"</span>
<span class="k">done</span>
<span class="c"># 验证镜像是否全部下载</span>
crictl images
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_添加_tab_命令补全_可选">添加 TAB 命令补全 （可选）</h3>
<div class="paragraph">
<p>对常用命令增加补全功能可极大提升效率。此功能需要部署 <code>bash-completion</code> 软件包。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="c"># 针对 bash 添加代码补全功能</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/bash_completion.d <span class="o">||</span>:
<span class="c"># 导入 kubectl</span>
kubectl completion bash | <span class="nb">tee</span> /etc/bash_completion.d/kubectl <span class="o">&gt;</span> /dev/null
<span class="c"># 导入 kubeadm</span>
kubeadm completion bash | <span class="nb">tee</span> /etc/bash_completion.d/kubeadm <span class="o">&gt;</span> /dev/null
<span class="c"># 导入 cri-tools</span>
crictl completion bash | <span class="nb">tee</span> /etc/bash_completion.d/kubeadm <span class="o">&gt;</span> /dev/null
<span class="nb">source</span> /usr/share/bash-completion/bash_completion
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你想创建 <code>kubectl</code> 的别名的话可使用如下命令添加命令补全功能。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span>~/.bashrc
<span class="nb">echo</span> <span class="s1">'complete -o default -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span>~/.bashrc
<span class="nb">source</span> ~/.bashrc
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_部署_kubernetes">部署 kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>一切环境准备完成后，即可开始部署 kubernetes。</p>
</div>
<div class="sect2">
<h3 id="_重置_kubernetes_可选">重置 kubernetes (可选)</h3>
<div class="paragraph">
<p>如果部署失败，可尝试重置 <code>kubernetes</code> 后重新部署。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="c"># 重置 kubeadm</span>
<span class="nb">yes</span> | kubeadm reset
<span class="c"># 删除 CNI 插件残留</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /etc/cni/net.d/
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_部署控制节点">部署控制节点</h3>
<div class="paragraph">
<p>控制节点部署在 <code>dragon-k8s-master</code> 机器上，SSH 连接机器，执行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="nb">unset </span>http_proxy
<span class="nb">unset </span>https_proxy
<span class="c"># 安装控制节点</span>
kubeadm init <span class="se">\</span>
    <span class="nt">--upload-certs</span> <span class="se">\</span>
    <span class="nt">--pod-network-cidr</span> 10.254.0.0/16 <span class="se">\</span>
    <span class="nt">--node-name</span> node-master | <span class="nb">tee</span> /tmp/kubectl-installer.log
<span class="nb">echo</span> <span class="s2">"export KUBECONFIG=/etc/kubernetes/admin.conf"</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">source</span> ~/.bashrc
<span class="nb">sleep </span>5
<span class="c"># 查看节点状态，有输出则表示成功</span>
kubectl get nodes
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果一切无误，则执行 <code>kubectl get nodes</code> 命令时会显示如下内容:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>NAME          STATUS     ROLES           AGE     VERSION
node-master   NotReady   control-plane   7m54s   v1.24.2
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_部署_cni_插件">部署 CNI 插件</h3>
<div class="paragraph">
<p>kubernetes 控制节点部署完成后，需要配置CNI网络插件实现各个节点之间的通信。</p>
</div>
<details>
<summary class="title">点击展开部署命令</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
</pre></td><td class="code"><pre><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">" &gt; /tmp/kube-flannel.yml
---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: psp.flannel.unprivileged
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default
    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
spec:
  privileged: false
  volumes:
    - configMap
    - secret
    - emptyDir
    - hostPath
  allowedHostPaths:
    - pathPrefix: "/etc/cni/net.d"
    - pathPrefix: "/etc/kube-flannel"
    - pathPrefix: "/run/flannel"
  readOnlyRootFilesystem: false
  # Users and groups
  runAsUser:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  # Privilege Escalation
  allowPrivilegeEscalation: false
  defaultAllowPrivilegeEscalation: false
  # Capabilities
  allowedCapabilities: [ 'NET_ADMIN', 'NET_RAW' ]
  defaultAddCapabilities: [ ]
  requiredDropCapabilities: [ ]
  # Host namespaces
  hostPID: false
  hostIPC: false
  hostNetwork: true
  hostPorts:
    - min: 0
      max: 65535
  # SELinux
  seLinux:
    # SELinux is unused in CaaSP
    rule: 'RunAsAny'
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
rules:
  - apiGroups: [ 'extensions' ]
    resources: [ 'podsecuritypolicies' ]
    verbs: [ 'use' ]
    resourceNames: [ 'psp.flannel.unprivileged' ]
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
  - apiGroups:
      - ""
    resources:
      - nodes
    verbs:
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - nodes/status
    verbs:
      - patch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
  - kind: ServiceAccount
    name: flannel
    namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-system
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-system
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: |
    {
      "name": "cbr0",
      "cniVersion": "0.3.1",
      "plugins": [
        {
          "type": "flannel",
          "delegate": {
            "hairpinMode": true,
            "isDefaultGateway": true
          }
        },
        {
          "type": "portmap",
          "capabilities": {
            "portMappings": true
          }
        }
      ]
    }
  net-conf.json: |
    {
      "Network": "10.254.0.0/16",
      "Backend": {
        "Type": "wireguard"
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-system
  labels:
    tier: node
    app: flannel
spec:
  selector:
    matchLabels:
      app: flannel
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/os
                    operator: In
                    values:
                      - linux
      hostNetwork: true
      priorityClassName: system-node-critical
      tolerations:
        - operator: Exists
          effect: NoSchedule
      serviceAccountName: flannel
      initContainers:
        - name: install-cni-plugin
          #image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)
          image: rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0
          command:
            - cp
          args:
            - -f
            - /flannel
            - /opt/cni/bin/flannel
          volumeMounts:
            - name: cni-plugin
              mountPath: /opt/cni/bin
        - name: install-cni
          #image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)
          image: rancher/mirrored-flannelcni-flannel:v0.18.1
          command:
            - cp
          args:
            - -f
            - /etc/kube-flannel/cni-conf.json
            - /etc/cni/net.d/10-flannel.conflist
          volumeMounts:
            - name: cni
              mountPath: /etc/cni/net.d
            - name: flannel-cfg
              mountPath: /etc/kube-flannel/
      containers:
        - name: kube-flannel
          #image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)
          image: rancher/mirrored-flannelcni-flannel:v0.18.1
          command:
            - /opt/bin/flanneld
          args:
            - --ip-masq
            - --kube-subnet-mgr
          resources:
            requests:
              cpu: "100m"
              memory: "50Mi"
            limits:
              cpu: "100m"
              memory: "50Mi"
          securityContext:
            privileged: false
            capabilities:
              add: [ "NET_ADMIN", "NET_RAW" ]
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: EVENT_QUEUE_DEPTH
              value: "5000"
          volumeMounts:
            - name: run
              mountPath: /run/flannel
            - name: flannel-cfg
              mountPath: /etc/kube-flannel/
            - name: xtables-lock
              mountPath: /run/xtables.lock
      volumes:
        - name: run
          hostPath:
            path: /run/flannel
        - name: cni-plugin
          hostPath:
            path: /opt/cni/bin
        - name: cni
          hostPath:
            path: /etc/cni/net.d
        - name: flannel-cfg
          configMap:
            name: kube-flannel-cfg
        - name: xtables-lock
          hostPath:
            path: /run/xtables.lock
            type: FileOrCreate
</span><span class="no">EOF
</span>kubectl apply <span class="nt">-f</span> /tmp/kube-flannel.yml
kubectl get pods <span class="nt">--all-namespaces</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>执行命令 <code>watch kubectl get pods --all-namespaces</code>, 直到出现类似于如下示例的回显即表示安装成功。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>NAMESPACE     NAME                                  READY   STATUS    RESTARTS      AGE
kube-system   coredns-6d4b75cb6d-5tmll              1/1     Running   0             15m
kube-system   coredns-6d4b75cb6d-j98fd              1/1     Running   0             15m
kube-system   etcd-node-master                      1/1     Running   2             15m
kube-system   kube-apiserver-node-master            1/1     Running   2 (16m ago)   16m
kube-system   kube-controller-manager-node-master   1/1     Running   2             16m
kube-system   kube-flannel-ds-d54gd                 1/1     Running   0             3m33s
kube-system   kube-proxy-n95j9                      1/1     Running   0             15m
kube-system   kube-scheduler-node-master            1/1     Running   2             16m
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>此时你可以使用 <code>wg</code> 命令查看部署的 <code>flannel</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_部署工作节点">部署工作节点</h3>
<div class="paragraph">
<p>在部署控制节点时，<code>kubeadm</code> 已将部署工作节点的命令展示到控制台，你还可以使用   <code>tail -n 2 /tmp/kubectl-installer.log</code> 查看命令。注意：Token 过期时间为 24小时，如果超过24小时，可在控制节点执行 <code>kubeadm token create</code> 重新生成 token.</p>
</div>
<div class="paragraph">
<p>在加入集群时，需为每个节点添加唯一标识，使用参数 <code>--node-name</code> 即可。 部署完成后，执行 <code>kubectl get nodes</code> ，控制台回显如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>NAME             STATUS   ROLES           AGE    VERSION
node-master      Ready    control-plane   46m    v1.24.2
node-worker-01   Ready    &lt;none&gt;          13m    v1.24.2
node-worker-02   Ready    &lt;none&gt;          105s   v1.24.2
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>至此，kubernetes (Google) 安装完成。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考">参考</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a target="_blank" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">部署 kubeadm</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<div class="custom-content">
    <style>
        .custom-footer {
            margin: 0;
            padding: 20px;
            background: #555555;
            color: white;
        }

        .custom-footer a {
            color: white;
        }
    </style>
    <p class="custom-footer">
        最后编辑于 2022年07月15日 00时44分35秒 |
        <a target="_blank"
           href="https://github.com/d7z-project/all-in-kubernetes/tree/2a195a69753b48f4ec7d238fd5bc58235e80bfe5//00-deploy-global/01.a-deploy-kubernetes-google/README.adoc">查看源码</a> |
        <a href="https://github.com/d7z-project/all-in-kubernetes/tree/2a195a69753b48f4ec7d238fd5bc58235e80bfe5/"
            target="_blank">#84f7d5d</a>
</div>
</body>
</html>