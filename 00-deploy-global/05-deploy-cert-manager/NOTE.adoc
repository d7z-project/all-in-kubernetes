= Cert Manager 相关笔记
:experimental:
:icons: font
:experimental:
:icons: font
:toc: right
:toc-title: 目录
:toclevels: 4
:source-highlighter: rouge

== 自签名证书

=== 创建 CA 证书 Issuer

[source%linenums,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: self-signed-issuer
  namespace: cert-manager
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: self-signed-cluster-issuer
  namespace: cert-manager
spec:
  selfSigned: {}
----

=== 创建 CA 证书

[source%linenums,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: self-signed-ca
  namespace: cert-manager
spec:
  secretName: self-signed-ca
  duration: 876000h # 100 year
  issuerRef:
    name: self-signed-issuer
  commonName: "ca.pcloud.com"
  isCA: true
----

=== 创建证书 Issuer

[source%linenums,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: self-issuer
  namespace: cert-manager
spec:
  ca:
    secretName: self-signed-ca
----

=== 签发证书

[source%linenums,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cert-pcloud-com
  namespace: cert-manager
spec:
  secretTemplate:
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "kube-system,default,core-system,core-middleware,core-app,share-app,monitor-app"
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "kube-system,default,core-system,core-middleware,core-app,share-app,monitor-app"
  secretName: pcloud-com-tls
  duration: 8760h # 1y
  issuerRef:
    name: self-issuer
  commonName: "ca.pcloud.com"
  dnsNames:
    - pcloud.com
    - '*.pcloud.com'
    - 'admin.pcloud.com'
    - '*.admin.pcloud.com'
----
