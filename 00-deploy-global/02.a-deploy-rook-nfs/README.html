<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>配置全局存储 (rook-nfs)</title>
<style>
@import url(https://fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>配置全局存储 (rook-nfs)</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_导入规则">导入规则</a></li>
<li><a href="#_映射节点目录">映射节点目录</a>
<ul class="sectlevel2">
<li><a href="#_创建_local_pv">创建 Local PV</a></li>
<li><a href="#_创建_host_storageclass">创建 Host StorageClass</a></li>
<li><a href="#_创建_host_persistentvolumeclaim">创建 Host PersistentVolumeClaim</a></li>
</ul>
</li>
<li><a href="#_创建nfs_server">创建NFS Server</a></li>
<li><a href="#_创建nfs_storage_class_关联">创建NFS Storage Class 关联</a></li>
<li><a href="#_验证部署情况">验证部署情况</a>
<ul class="sectlevel2">
<li><a href="#_导入测试配置">导入测试配置</a></li>
<li><a href="#_验证测试">验证测试</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>kubernetes 安装后可选择一个节点的某个目录作为集群数据存储目录。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
rook-nfs 项目已经<a target="_blank" href="https://github.com/rook/nfs#deprecated">过时</a>，未来此文档可能会被替换,正在寻找替代方案，如果你有好的方案可告诉我，暂不考虑 <code>Ceph</code> 等类似的块存储方案 。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_导入规则">导入规则</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在开始前需要导入RBAC规则和初始化配置，此过程需要拉取镜像 <code>rook/nfs:v1.7.3</code>,同时需要集群上每个节点安装有 <code>nfs-common</code> 软件包。</p>
</div>
<details>
<summary class="title">点击展开配置</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apiextensions.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CustomResourceDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">controller-gen.kubebuilder.io/version</span><span class="pi">:</span> <span class="s">v0.5.1-0.20210420220833-f284e2e8098c</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nfsservers.nfs.rook.io</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">nfs.rook.io</span>
  <span class="na">names</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">NFSServer</span>
    <span class="na">listKind</span><span class="pi">:</span> <span class="s">NFSServerList</span>
    <span class="na">plural</span><span class="pi">:</span> <span class="s">nfsservers</span>
    <span class="na">singular</span><span class="pi">:</span> <span class="s">nfsserver</span>
  <span class="na">scope</span><span class="pi">:</span> <span class="s">Namespaced</span>
  <span class="na">versions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">additionalPrinterColumns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">jsonPath</span><span class="pi">:</span> <span class="s">.metadata.creationTimestamp</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">AGE</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">date</span>
        <span class="pi">-</span> <span class="na">description</span><span class="pi">:</span> <span class="s">NFS Server instance state</span>
          <span class="na">jsonPath</span><span class="pi">:</span> <span class="s">.status.state</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">State</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">v1alpha1</span>
      <span class="na">schema</span><span class="pi">:</span>
        <span class="na">openAPIV3Schema</span><span class="pi">:</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s">NFSServer is the Schema for the nfsservers API</span>
          <span class="na">properties</span><span class="pi">:</span>
            <span class="na">apiVersion</span><span class="pi">:</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">APIVersion</span><span class="nv"> </span><span class="s">defines</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">versioned</span><span class="nv"> </span><span class="s">schema</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">representation</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">object.</span><span class="nv"> </span><span class="s">Servers</span><span class="nv"> </span><span class="s">should</span><span class="nv"> </span><span class="s">convert</span><span class="nv"> </span><span class="s">recognized</span><span class="nv"> </span><span class="s">schemas</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">latest</span><span class="nv"> </span><span class="s">internal</span><span class="nv"> </span><span class="s">value,</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">may</span><span class="nv"> </span><span class="s">reject</span><span class="nv"> </span><span class="s">unrecognized</span><span class="nv"> </span><span class="s">values.</span><span class="nv"> </span><span class="s">More</span><span class="nv"> </span><span class="s">info:</span><span class="nv"> </span><span class="s">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
            <span class="na">kind</span><span class="pi">:</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kind</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">string</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">representing</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">REST</span><span class="nv"> </span><span class="s">resource</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">object</span><span class="nv"> </span><span class="s">represents.</span><span class="nv"> </span><span class="s">Servers</span><span class="nv"> </span><span class="s">may</span><span class="nv"> </span><span class="s">infer</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">endpoint</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">client</span><span class="nv"> </span><span class="s">submits</span><span class="nv"> </span><span class="s">requests</span><span class="nv"> </span><span class="s">to.</span><span class="nv"> </span><span class="s">Cannot</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">updated.</span><span class="nv"> </span><span class="s">In</span><span class="nv"> </span><span class="s">CamelCase.</span><span class="nv"> </span><span class="s">More</span><span class="nv"> </span><span class="s">info:</span><span class="nv"> </span><span class="s">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
            <span class="na">metadata</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
            <span class="na">spec</span><span class="pi">:</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s">NFSServerSpec represents the spec of NFS daemon</span>
              <span class="na">properties</span><span class="pi">:</span>
                <span class="na">annotations</span><span class="pi">:</span>
                  <span class="na">additionalProperties</span><span class="pi">:</span>
                    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                  <span class="na">description</span><span class="pi">:</span> <span class="s">The annotations-related configuration to add/set on each Pod related object.</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
                <span class="na">exports</span><span class="pi">:</span>
                  <span class="na">description</span><span class="pi">:</span> <span class="s">The parameters to configure the NFS export</span>
                  <span class="na">items</span><span class="pi">:</span>
                    <span class="na">description</span><span class="pi">:</span> <span class="s">ExportsSpec represents the spec of NFS exports</span>
                    <span class="na">properties</span><span class="pi">:</span>
                      <span class="na">name</span><span class="pi">:</span>
                        <span class="na">description</span><span class="pi">:</span> <span class="s">Name of the export</span>
                        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                      <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
                        <span class="na">description</span><span class="pi">:</span> <span class="s">PVC from which the NFS daemon gets storage for sharing</span>
                        <span class="na">properties</span><span class="pi">:</span>
                          <span class="na">claimName</span><span class="pi">:</span>
                            <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ClaimName</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">PersistentVolumeClaim</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">same</span><span class="nv"> </span><span class="s">namespace</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">pod</span><span class="nv"> </span><span class="s">using</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">volume.</span><span class="nv"> </span><span class="s">More</span><span class="nv"> </span><span class="s">info:</span><span class="nv"> </span><span class="s">https://kubernetes.io/docs/concepts/storage/persistent-volumes#persistentvolumeclaims'</span>
                            <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                          <span class="na">readOnly</span><span class="pi">:</span>
                            <span class="na">description</span><span class="pi">:</span> <span class="s">Will force the ReadOnly setting in VolumeMounts. Default </span><span class="no">false</span><span class="s">.</span>
                            <span class="na">type</span><span class="pi">:</span> <span class="s">boolean</span>
                        <span class="na">required</span><span class="pi">:</span>
                          <span class="pi">-</span> <span class="s">claimName</span>
                        <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
                      <span class="na">server</span><span class="pi">:</span>
                        <span class="na">description</span><span class="pi">:</span> <span class="s">The NFS server configuration</span>
                        <span class="na">properties</span><span class="pi">:</span>
                          <span class="na">accessMode</span><span class="pi">:</span>
                            <span class="na">description</span><span class="pi">:</span> <span class="s">Reading and Writing permissions on the export Valid values are "ReadOnly", "ReadWrite" and "none"</span>
                            <span class="na">enum</span><span class="pi">:</span>
                              <span class="pi">-</span> <span class="s">ReadOnly</span>
                              <span class="pi">-</span> <span class="s">ReadWrite</span>
                              <span class="pi">-</span> <span class="s">none</span>
                            <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                          <span class="na">allowedClients</span><span class="pi">:</span>
                            <span class="na">description</span><span class="pi">:</span> <span class="s">The clients allowed to access the NFS export</span>
                            <span class="na">items</span><span class="pi">:</span>
                              <span class="na">description</span><span class="pi">:</span> <span class="s">AllowedClientsSpec represents the client specs for accessing the NFS export</span>
                              <span class="na">properties</span><span class="pi">:</span>
                                <span class="na">accessMode</span><span class="pi">:</span>
                                  <span class="na">description</span><span class="pi">:</span> <span class="s">Reading and Writing permissions for the client to access the NFS export Valid values are "ReadOnly", "ReadWrite" and "none" Gets overridden when ServerSpec.accessMode is specified</span>
                                  <span class="na">enum</span><span class="pi">:</span>
                                    <span class="pi">-</span> <span class="s">ReadOnly</span>
                                    <span class="pi">-</span> <span class="s">ReadWrite</span>
                                    <span class="pi">-</span> <span class="s">none</span>
                                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                                <span class="na">clients</span><span class="pi">:</span>
                                  <span class="na">description</span><span class="pi">:</span> <span class="s">The clients that can access the share Values can be hostname, ip address, netgroup, CIDR network address, or all</span>
                                  <span class="na">items</span><span class="pi">:</span>
                                    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                                  <span class="na">type</span><span class="pi">:</span> <span class="s">array</span>
                                <span class="na">name</span><span class="pi">:</span>
                                  <span class="na">description</span><span class="pi">:</span> <span class="s">Name of the clients group</span>
                                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                                <span class="na">squash</span><span class="pi">:</span>
                                  <span class="na">description</span><span class="pi">:</span> <span class="s">Squash options for clients Valid values are "none", "rootid", "root", and "all" Gets overridden when ServerSpec.squash is specified</span>
                                  <span class="na">enum</span><span class="pi">:</span>
                                    <span class="pi">-</span> <span class="s">none</span>
                                    <span class="pi">-</span> <span class="s">rootid</span>
                                    <span class="pi">-</span> <span class="s">root</span>
                                    <span class="pi">-</span> <span class="s">all</span>
                                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                              <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
                            <span class="na">type</span><span class="pi">:</span> <span class="s">array</span>
                          <span class="na">squash</span><span class="pi">:</span>
                            <span class="na">description</span><span class="pi">:</span> <span class="s">This prevents the root users connected remotely from having root privileges Valid values are "none", "rootid", "root", and "all"</span>
                            <span class="na">enum</span><span class="pi">:</span>
                              <span class="pi">-</span> <span class="s">none</span>
                              <span class="pi">-</span> <span class="s">rootid</span>
                              <span class="pi">-</span> <span class="s">root</span>
                              <span class="pi">-</span> <span class="s">all</span>
                            <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                        <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
                    <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">array</span>
                <span class="na">replicas</span><span class="pi">:</span>
                  <span class="na">description</span><span class="pi">:</span> <span class="s">Replicas of the NFS daemon</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">integer</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
            <span class="na">status</span><span class="pi">:</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s">NFSServerStatus defines the observed state of NFSServer</span>
              <span class="na">properties</span><span class="pi">:</span>
                <span class="na">message</span><span class="pi">:</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                <span class="na">reason</span><span class="pi">:</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
                <span class="na">state</span><span class="pi">:</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
      <span class="na">served</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">subresources</span><span class="pi">:</span>
        <span class="na">status</span><span class="pi">:</span> <span class="pi">{</span> <span class="pi">}</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">acceptedNames</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">plural</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">conditions</span><span class="pi">:</span> <span class="pi">[</span> <span class="pi">]</span>
  <span class="na">storedVersions</span><span class="pi">:</span> <span class="pi">[</span> <span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-system</span> <span class="c1"># namespace:operator</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs-system</span> <span class="c1"># namespace:operator</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs-system</span> <span class="c1"># namespace:operator</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">configmaps</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">create</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">events</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">create</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pods</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">services</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">create</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">apps</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">statefulsets</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">create</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nfs.rook.io</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nfsservers</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">create</span>
      <span class="pi">-</span> <span class="s">delete</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nfs.rook.io</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nfsservers/status</span>
      <span class="pi">-</span> <span class="s">nfsservers/finalizers</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">patch</span>
      <span class="pi">-</span> <span class="s">update</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs-system</span> <span class="c1"># namespace:operator</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-operator</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">rook/nfs:v1.7.3</span>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
          <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">nfs"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">operator"</span> <span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAME</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">fieldRef</span><span class="pi">:</span>
                  <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.name</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">fieldRef</span><span class="pi">:</span>
                  <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-server</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-provisioner-runner</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">persistentvolumes"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">delete"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">persistentvolumeclaims"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">storage.k8s.io"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">storageclasses"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">events"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">patch"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">services"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">endpoints"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">get"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">policy"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">podsecuritypolicies"</span> <span class="pi">]</span>
    <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">rook-nfs-policy"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">use"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">"</span> <span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">endpoints"</span> <span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">patch"</span> <span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nfs.rook.io</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-provisioner-runner</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span>
      <span class="s">rook-nfs-server</span>
    <span class="c1"># replace with namespace where provisioner is deployed</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs-provisioner-runner</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>部署完成后， 执行 <code>kubectl get pods -n rook-nfs-system</code>  命令查看部署结果。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_映射节点目录">映射节点目录</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_创建_local_pv">创建 Local PV</h3>
<div class="paragraph">
<p>首先在集群的宿主机创建挂载点，这里使用的是 <code>/share</code>。使用以下配置创建 <code>PersistentVolume</code>, 如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nfs-local-pv-share</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">1000Gi</span>
  <span class="na">local</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/share</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">nodeAffinity</span><span class="pi">:</span>
    <span class="na">required</span><span class="pi">:</span>
      <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">node-worker-01</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">nfs-local-sc-share</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<div class="title">其中:</div>
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>表明这是 <strong>Persistent Volume</strong> , <code>path</code> 字段指定的正是这个 PV 对应的本地磁盘的路径，即 <code>/share</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>指定此 PV 位于 <code>node-worker-01</code> 节点上，节点名称可通过 <code>kubectl get nodes</code> 查看。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>创建完成后使用 <code>kubectl get pv</code> 查看创建结果。</p>
</div>
</div>
<div class="sect2">
<h3 id="_创建_host_storageclass">创建 Host StorageClass</h3>
<div class="paragraph">
<p>创建 StorageClass 关联刚刚创建的PV, 创建配置如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nfs-local-sc-share</span>
<span class="na">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/no-provisioner</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">reclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
<span class="na">volumeBindingMode</span><span class="pi">:</span> <span class="s">WaitForFirstConsumer</span> <i class="conum" data-value="2"></i><b>(2)</b>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<div class="title">其中：</div>
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>provisioner</code>: 我们使用 <code>no-provisioner</code>, 这是因为 <strong>Local Persistent Volume</strong> 目前尚不支持 <a target="_blank" href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning"><strong>Dynamic Provisioning</strong></a>，所以它没办法在用户创建 PVC 的时候,就自动创建出对应的PV。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>volumeBindingMode: WaitForFirstConsumer</code> 指定了延迟绑定。因为 <strong>Local Persistent</strong> 需要等到调度时才可以进行绑定操作。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_创建_host_persistentvolumeclaim">创建 Host PersistentVolumeClaim</h3>
<div class="paragraph">
<p>创建 PVC，供之后创建的 NFS Server 使用。可使用以下配置创建：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nfs-local-pvc-share</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">100Gi</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">nfs-local-sc-share</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">volumeName</span><span class="pi">:</span> <span class="s">nfs-local-pv-share</span> <span class="c1"># 指定关联的PV 名称</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>配置导入完成后使用 <code>kubectl get pvc  -n rook-nfs</code> 查看导入结果。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_创建nfs_server">创建NFS Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们可以通过创建 <code>nfsservers.nfs.rook.io</code> 资源的实例来创建NFS服务器的实例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">nfs.rook.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NFSServer</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-nfs</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">exports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">local-share</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">accessMode</span><span class="pi">:</span> <span class="s">ReadWrite</span>
        <span class="na">squash</span><span class="pi">:</span> <span class="s">none</span>
      <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
        <span class="na">claimName</span><span class="pi">:</span> <span class="s">nfs-local-pvc-share</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">rook</span><span class="pi">:</span> <span class="s">nfs</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>创建完成后，可使用 <code>kubectl get pods  -n rook-nfs</code> 和 <code>kubectl get nfsservers.nfs.rook.io -n rook-nfs</code> 查看 Server 状态，如果 Pod 结果为 <code>RUN</code> 则表明创建成功。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_创建nfs_storage_class_关联">创建NFS Storage Class 关联</h2>
<div class="sectionbody">
<div class="paragraph">
<p>部署 <strong>Operator</strong> 和 <strong>NFS Server</strong> 实例之后, 须创建 <code>StrorageClass</code> 来动态配置 <code>Volume</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">rook-nfs</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster-share</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">exportName</span><span class="pi">:</span> <span class="s">local-share</span>
  <span class="na">nfsServerName</span><span class="pi">:</span> <span class="s">rook-nfs</span>
  <span class="na">nfsServerNamespace</span><span class="pi">:</span> <span class="s">rook-nfs</span>
<span class="na">provisioner</span><span class="pi">:</span> <span class="s">nfs.rook.io/rook-nfs-provisioner</span>
<span class="na">reclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
<span class="na">volumeBindingMode</span><span class="pi">:</span> <span class="s">Immediate</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_验证部署情况">验证部署情况</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_导入测试配置">导入测试配置</h3>
<div class="paragraph">
<p>导入以下配置以创建测试 Pod。</p>
</div>
<details>
<summary class="title">点击展开配置</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="code"><pre><span class="c">## 测试</span>
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cluster-test-pvc
spec:
  storageClassName: cluster-share
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
<span class="nt">---</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nfs-demo
    role: web-frontend
  name: nfs-web
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nfs-demo
      role: web-frontend
  template:
    metadata:
      labels:
        app: nfs-demo
        role: web-frontend
    spec:
      containers:
        - name: web
          image: nginx
          ports:
            - name: web
              containerPort: 80
          volumeMounts:
            <span class="c"># name must match the volume name below</span>
            - name: rook-nfs-vol
              mountPath: <span class="s2">"/usr/share/nginx/html"</span>
      volumes:
        - name: rook-nfs-vol
          persistentVolumeClaim:
            claimName: cluster-test-pvc
<span class="nt">---</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nfs-demo
    role: busybox
  name: nfs-busybox
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nfs-demo
      role: busybox
  template:
    metadata:
      labels:
        app: nfs-demo
        role: busybox
    spec:
      containers:
        - image: busybox
          <span class="nb">command</span>:
            - sh
            - <span class="nt">-c</span>
            - <span class="s2">"while true; do date &gt; /mnt/index.html; hostname &gt;&gt; /mnt/index.html; sleep </span><span class="k">$((</span><span class="nv">$RANDOM</span> <span class="o">%</span> <span class="m">5</span> <span class="o">+</span> <span class="m">5</span><span class="k">))</span><span class="s2">; done"</span>
          imagePullPolicy: IfNotPresent
          name: busybox
          volumeMounts:
            <span class="c"># name must match the volume name below</span>
            - name: rook-nfs-vol
              mountPath: <span class="s2">"/mnt"</span>
      volumes:
        - name: rook-nfs-vol
          persistentVolumeClaim:
            claimName: cluster-test-pvc
<span class="nt">---</span>
kind: Service
apiVersion: v1
metadata:
  name: nfs-web
spec:
  ports:
    - port: 80
  selector:
    role: web-frontend
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_验证测试">验证测试</h3>
<div class="paragraph">
<p>执行完成后使用 <code>kubectl get pods</code> 查看创建情况。创建完成后，执行以下命令，有数据返回则表示成功：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">echo</span><span class="p">;</span> kubectl <span class="nb">exec</span> <span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>nfs-demo,role<span class="o">=</span>busybox <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span> <span class="nt">--</span> wget <span class="nt">-qO-</span> http://<span class="si">$(</span>kubectl get services nfs-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span><span class="p">;</span> <span class="nb">echo</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果返回403错误，可能是因为文件系统权限问题，可通过 <code>kubectl exec</code> 手动查看。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<div class="custom-content">
    <style>
        .custom-footer {
            margin: 0;
            padding: 20px;
            background: #555555;
            color: white;
        }

        .custom-footer a {
            color: white;
        }
    </style>
    <p class="custom-footer">
        最后编辑于 2022年07月15日 00时44分35秒 |
        <a target="_blank"
           href="https://github.com/d7z-project/all-in-kubernetes/tree/e45ddf4968e1d7e941c2ca3f893db650eb5ccbce//00-deploy-global/02.a-deploy-rook-nfs/README.adoc">查看源码</a> |
        <a href="https://github.com/d7z-project/all-in-kubernetes/tree/e45ddf4968e1d7e941c2ca3f893db650eb5ccbce/"
            target="_blank">#84f7d5d</a>
</div>
</body>
</html>