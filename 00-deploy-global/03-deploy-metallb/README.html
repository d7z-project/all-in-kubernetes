<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>安装 LoadBalancer 组件实现 (MetalLB)</title>
<style>
@import url(https://fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>安装 LoadBalancer 组件实现 (MetalLB)</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_环境准备">环境准备</a></li>
<li><a href="#_导入资源">导入资源</a></li>
<li><a href="#_配置_loadbalancer_地址">配置 LoadBalancer 地址</a></li>
<li><a href="#_验证部署结果">验证部署结果</a>
<ul class="sectlevel2">
<li><a href="#_导入测试配置">导入测试配置</a></li>
<li><a href="#_验证测试结果">验证测试结果</a></li>
</ul>
</li>
<li><a href="#_扩展">扩展</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>项目地址：<a target="_blank" href="https://metallb.universe.tf/">MetalLB</a></p>
</div>
<div class="paragraph">
<p>为了系统的扩展性和稳定性，我们需要将服务暴露到单独的 IP 上，避免使用 Kubernetes 集群IP。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_环境准备">环境准备</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果您在 <strong>IPVS</strong> 模式下使用 <code>kube-proxy</code>，从 <strong>Kubernetes v1.14.2</strong> 开始，您必须启用严格的 <strong>ARP</strong> 模式。</p>
</div>
<div class="paragraph">
<p>执行如下命令完成配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="c"># see what changes would be made, returns nonzero returncode if different</span>
kubectl get configmap kube-proxy <span class="nt">-n</span> kube-system <span class="nt">-o</span> yaml | <span class="se">\</span>
<span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/strictARP: false/strictARP: true/"</span> | <span class="se">\</span>
kubectl diff <span class="nt">-f</span> - <span class="nt">-n</span> kube-system

<span class="c"># actually apply the changes, returns nonzero returncode on errors only</span>
kubectl get configmap kube-proxy <span class="nt">-n</span> kube-system <span class="nt">-o</span> yaml | <span class="se">\</span>
<span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/strictARP: false/strictARP: true/"</span> | <span class="se">\</span>
kubectl apply <span class="nt">-f</span> - <span class="nt">-n</span> kube-system
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_导入资源">导入资源</h2>
<div class="sectionbody">
<div class="paragraph">
<p>由于 MetalLB 的配置过于庞大，不便于在此展示，可将文件 <a href="conf/00-metallb-native.yaml">conf/metallb-native.yaml</a> 推送到控制节点，再使用 <code>kubectl apply -f metallb-native.yaml</code> 导入资源。</p>
</div>
<div class="paragraph">
<p>或者你可以使用以下命令在线导入资源：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/metallb/metallb/v0.13.3/config/manifests/metallb-native.yaml
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>MetalLB 需要以下镜像：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>crictl pull quay.io/metallb/controller:v0.13.3
crictl pull quay.io/metallb/speaker:v0.13.3
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>导入完成后使用以下命令查看结果：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>kubectl get pods <span class="nt">-n</span> metallb-system <span class="nt">-o</span> wide
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果一切无误，则会在所有节点上启动 <code>speaker</code> 。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置_loadbalancer_地址">配置 LoadBalancer 地址</h2>
<div class="sectionbody">
<div class="paragraph">
<p>安装完成后，需要指定 LoadBalancer 可分配的地址。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
由于是小型化部署，所以 L2 模式已经够用，当然，如果你是自建机房，想使用 BGP 的方案的话可自行查阅文档。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">metallb.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPAddressPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">primary-pool</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">metallb-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">addresses</span><span class="pi">:</span>
    <span class="c1"># 根据实际需求自行配置</span>
    <span class="pi">-</span> <span class="s">10.0.0.35-10.0.0.39</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="c1">#   - 10.0.2.0/24</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">metallb.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">L2Advertisement</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">l2-net</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">metallb-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ipAddressPools</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">primary-pool</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<div class="title">其中：</div>
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>用于指定 LoadBalancer 可用的地址。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_验证部署结果">验证部署结果</h2>
<div class="sectionbody">
<div class="paragraph">
<p>执行以下步骤，验证部署结果。</p>
</div>
<div class="sect2">
<h3 id="_导入测试配置">导入测试配置</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-deployment</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.14.2</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_验证测试结果">验证测试结果</h3>
<div class="paragraph">
<p>执行以下命令，验证测试结果</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>kubectl get service,pods
<span class="c"># 查看LD 的 IP</span>
kubectl get service <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.loadBalancer.ingress[*].ip}'</span>
<span class="nv">ADDRESS</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.loadBalancer.ingress[*].ip}'</span><span class="si">)</span>
curl http://<span class="nv">$ADDRESS</span>/
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果一切无误，将看到 Pod 启动完成且 Service 有 <strong>EXTERNAL-IP</strong> ，浏览器可正常访问此地址。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_扩展">扩展</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a target="_blank" href="https://metallb.universe.tf/usage/#ip-address-sharing">不同服务使用同一IP</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<div class="custom-content">
    <style>
        .custom-footer {
            margin: 0;
            padding: 20px;
            background: #555555;
            color: white;
        }

        .custom-footer a {
            color: white;
        }
    </style>
    <p class="custom-footer">
        最后编辑于 2022年07月15日 00时44分35秒 |
        <a target="_blank"
           href="https://github.com/d7z-project/all-in-kubernetes/tree/e45ddf4968e1d7e941c2ca3f893db650eb5ccbce//00-deploy-global/03-deploy-metallb/README.adoc">查看源码</a> |
        <a href="https://github.com/d7z-project/all-in-kubernetes/tree/e45ddf4968e1d7e941c2ca3f893db650eb5ccbce/"
            target="_blank">#84f7d5d</a>
</div>
</body>
</html>