= 部署 Gitlab CE
:experimental:
:icons: font
:experimental:
:icons: font
:toc: right
:toc-title: 目录
:toclevels: 4
:source-highlighter: rouge

== 说明

Gitlab 依赖镜像 `sameersbn/gitlab:15.1.2`, 如在离线环境请自行导入镜像;同时，Gitlab 还需要 `Postgres` 和 `Redis` ，请在部署 `Gitlab` 前对其配置。

== 注意事项

由于 *Gitlab CE* 不支持 LDAP 分配管理员 （这是 *Gitlab EE* 的功能） ，所以需要安装后手动为用户分配管理员权限，如无法接受可使用 *Gitea* 部署。

== 部署前准备

*Gitlab* 依赖于 *Postgres* 和 *Redis*，在安装前你需要预先配置其依赖。

=== 配置数据源

TIP: 在生产环境部署建议使用 *Gitlab* 推荐的 *Postgres* 版本，且应将 *Postgres* 单独部署，具体的要求可参考 link:https://github.com/sameersbn/docker-gitlab#external-postgresql-server[sameersbn/docker-gitlab]，在这里我们直接使用之前部署的 *Postgres*。

使用如下命令连接 `Postgres` 控制台。

[source%linenums,bash]
----
kubectl exec -it -n core-middle postgres-server-0 -- psql -U postgres
----

连接建立后，执行如下 *SQL* 语句创建 *Gitlab* 的 *Postgres* 账户和数据库，执行完成后，使用 `\q` 退出。。

[source%linenums,sql]
----
CREATE ROLE gitlab with LOGIN CREATEDB PASSWORD 'password'; -- <1>
CREATE DATABASE gitlabhq_production;
GRANT ALL PRIVILEGES ON DATABASE gitlabhq_production to gitlab;
----

.注意
<1> 如果你修改了此处的密码，则需要在接下来的配置中也要同步修改。

创建完成后执行如下命令为数据库 `gitlabhq_production` 增加 `pg_trgm` 扩展。

[source%linenums,bash]
----
kubectl exec -it -n core-middle postgres-server-0 -- psql -U gitlab -d gitlabhq_production -c "CREATE EXTENSION pg_trgm;"
----

至此，数据源配置完成。

=== 创建 Gitlab 配置

[source%linenums,yaml]
----
include::./conf/00-gitlab-conf.yaml[]
----
